# 2\. μ•„ν‚¤ν…μ² (Architecture)

PRDμ μ”κµ¬μ‚¬ν•­(F1, F2, F3)μ„ κµ¬ν„ν•κΈ° μ„ν•΄ **νΌμ‚¬λ“(Facade)**, **μ»΄ν¬μ§“(Composite)**, **λΉ„μ§€ν„°(Visitor)** λ””μμΈ ν¨ν„΄μ„ κΈ°λ°μΌλ΅ μ‹μ¤ν…μ„ μ„¤κ³„ν•©λ‹λ‹¤.

## 2.1. ν•µμ‹¬ μ»΄ν¬λ„νΈ

* **A. `AlphaLab` (`rc` κ°μ²΄): νΌμ‚¬λ“ (Facade) π›οΈ**

  * **μ—­ν• :** `rc` κ°μ²΄λ” "μµμƒμ„ μ»¨νΈλ΅¤λ¬"μ΄μ μ‚¬μ©μλ¥Ό μ„ν• \*\*λ‹¨μΌ ν†µν•© μΈν„°νμ΄μ¤(Facade)\*\*μ…λ‹λ‹¤. "ν™μ‹μ–΄ν„° νΌμ‚¬λ“"κ°€ `DvdPlayer`, `Projector`, `Amplifier` λ“± λ³µμ΅ν• μ„λΈμ‹μ¤ν…μ„ μ§€νν•λ“―, `rc`λ” λ‹¤μκ³Ό κ°™μ€ λ‚΄λ¶€ μ»΄ν¬λ„νΈλ“¤μ„ μ§€νν•κ³  μ΅°μ¨ν•©λ‹λ‹¤.
  * **μ†μ  μ»΄ν¬λ„νΈ:**
        1. **`rc.db` (State):** `xarray.Dataset` μΈμ¤ν„΄μ¤. λ¨λ“  `(T, N)` λ°μ΄ν„°(μ›λ³Έ, λ²„ν‚·, μ‹κ·Έλ„)κ°€ `DataArray`λ΅ μ €μ¥λλ” ν•µμ‹¬ "λ°μ΄ν„° μ €μ¥μ†"μ…λ‹λ‹¤.
        2. **`rc.rules` (Registry):** `add_axis`λ΅ μ •μλ "λ£°"(`Expression` κ°μ²΄)μ„ μ €μ¥ν•λ” `dict`μ…λ‹λ‹¤.
        3. **`rc._evaluator` (Executor):** `EvaluateVisitor`μ μΈμ¤ν„΄μ¤. `Expression` "λ μ‹ν”Ό"λ¥Ό μ‹¤ν–‰ν•λ” "μ‹¤ν–‰μ"μ…λ‹λ‹¤.
        4. (κΈ°νƒ€) `ConfigLoader`, `PnLTracer` λ“±

* **B. `Expression` νΈλ¦¬: μ»΄ν¬μ§“ (Composite) π“**

  * **μ—­ν• :** "κ³„μ‚°λ²•" λλ” "λ μ‹ν”Ό"μ…λ‹λ‹¤. **μ»΄ν¬μ§“ ν¨ν„΄**μ„ λ”°λ¥΄λ” λ°μ΄ν„° κµ¬μ΅°μ…λ‹λ‹¤.
  * **κµ¬μ΅°:**
    * `Expression`μ€ λ¨λ“  μ—°μ‚° λ…Έλ“μ μ¶”μƒ μΈν„°νμ΄μ¤μ…λ‹λ‹¤.
    * **Leaf (λ¦¬ν”„):** `Field('close')`μ™€ κ°™μ΄ μμ‹μ΄ μ—†λ” λ…Έλ“μ…λ‹λ‹¤.
    * **Composite (λ³µν•©):** `ts_mean(Field('close'), 10)`μ™€ κ°™μ΄ λ‹¤λ¥Έ `Expression` λ…Έλ“λ¥Ό μμ‹μΌλ΅ κ°–λ” νΈλ¦¬(Tree) κµ¬μ΅°μ…λ‹λ‹¤.
  * **νΉμ§•:** `Expression` κ°μ²΄λ” μ‹¤μ  λ°μ΄ν„°(`(T, N)` λ°°μ—΄)λ¥Ό μ „ν€ κ°€μ§€μ§€ μ•κ³ , "κ³„μ‚° λ£°"μ— λ€ν• μ •μλ§ κ°€μ§‘λ‹λ‹¤.

* **C. `Visitor` ν¨ν„΄: μ‹¤ν–‰ λ° μ¶”μ  (Visitor) π‘¨β€π³**

  * **μ—­ν• :** `Expression` νΈλ¦¬(λ μ‹ν”Ό)λ¥Ό "λ°©λ¬Έ(visit)"ν•λ©° μ‹¤μ  μ‘μ—…μ„ μν–‰ν•λ” "μ‹¤ν–‰μ"μ…λ‹λ‹¤. **`Expression` κ°μ²΄μ™€λ” μ™„μ „ν λ¶„λ¦¬λ λ³„κ°μ ν΄λμ¤**μ…λ‹λ‹¤.
  * **`EvaluateVisitor`:** `rc` κ°μ²΄(`rc._evaluator`)κ°€ μ†μ ν•λ©°, `Expression` νΈλ¦¬λ¥Ό μνν•λ©° `rc.db`μ λ°μ΄ν„°λ¥Ό μ°Έμ΅°ν•μ—¬ μ‹¤μ  `xarray.DataArray`λ¥Ό κ³„μ‚°ν•©λ‹λ‹¤.

## 2.2. κΈ°λ¥λ³„ μ•„ν‚¤ν…μ² κµ¬ν„

* **F1 (λ°μ΄ν„° κ²€μƒ‰):**

    1. `rc.add_data('close', Field('price_close'))` νΈμ¶ μ‹, `rc`λ” `Field('price_close')`λ¥Ό `rc.rules`μ— λ“±λ΅ν•©λ‹λ‹¤.
    2. μ΄ν›„ `EvaluateVisitor`κ°€ `Field('price_close')` λ…Έλ“λ¥Ό λ°©λ¬Έν•λ©΄, `ConfigLoader`λ¥Ό νΈμ¶ν•μ—¬ `data_config.yaml`μ„ μ½κ³  SQLμ„ μ‹¤ν–‰ν•©λ‹λ‹¤.
    3. κ²°κ³Ό `(T, N)` `DataArray`λ¥Ό `rc.db['close']`μ— μ €μ¥(μΊμ‹)ν•©λ‹λ‹¤.

* **F2 (μ…€λ ‰ν„° μΈν„°νμ΄μ¤):**

    1. `rc.add_axis('size', cs_quantile(rc.data.mcap, ...))` νΈμ¶ μ‹, `rc`λ” μ΄ `cs_quantile` `Expression` κ°μ²΄λ¥Ό `rc.rules['size']`μ— λ“±λ΅ν•©λ‹λ‹¤.
    2. μ‚¬μ©μκ°€ `mask = rc.axis.size['small']`μ„ νΈμ¶ν•©λ‹λ‹¤.
    3. `rc`λ” `rc.rules['size']`μ—μ„ `Expression`μ„ κΊΌλ‚΄ `Equals(..., 'small')`μ΄λΌλ” μƒ `Expression`μ„ λ§λ“­λ‹λ‹¤.
    4. `rc._evaluator` (Visitor)μ—κ² μ΄ `Expression`μ„ ν‰κ°€(evaluate)ν•λ„λ΅ μ§€μ‹ν•©λ‹λ‹¤.
    5. `EvaluateVisitor`κ°€ `(T, N)` λ¶λ¦¬μ–Έ λ§μ¤ν¬λ¥Ό λ°ν™ν•©λ‹λ‹¤.
    6. μ‚¬μ©μκ°€ `rc[mask] = 1.0`μ„ νΈμ¶ν•λ©΄, `rc`λ” `rc.db['my_alpha']` μΊ”λ²„μ¤μ— `xr.where`λ¥Ό μ‚¬μ©ν•μ—¬ κ°’μ„ ν• λ‹Ή(overwrite)ν•©λ‹λ‹¤.

* **F3 (μ‹¬μΈµ μ¶”μ μ„±):**

    1. `rc._evaluator` (Visitor)λ” **"Stateful(μƒνƒ μ €μ¥)"** κ°μ²΄μ…λ‹λ‹¤.
    2. `EvaluateVisitor`λ” λ‚΄λ¶€μ— `cache` (e.g., `dict`)λ¥Ό μ†μ ν•©λ‹λ‹¤.
    3. `rc.add_data_var('alpha1', ...)`κ°€ νΈμ¶λλ©΄, `Visitor`λ” `alpha1`μ `Expression` νΈλ¦¬λ¥Ό μνν•λ©΄μ„ **κ° λ…Έλ“κ°€ λ°ν™ν•λ” μ¤‘κ°„ κ²°κ³Ό `(T, N) DataArray`λ¥Ό `self.cache`μ— λ¨λ‘ μ €μ¥**ν•©λ‹λ‹¤. (e.g., `cache['returns']`, `cache['ts_mean(...)']` λ“±)
    4. μ‚¬μ©μκ°€ `rc.trace_pnl('alpha1')`λ¥Ό νΈμ¶ν•λ©΄, `rc`λ” `rc._evaluator.cache`μ— μ €μ¥λ `(T, N)` λ°°μ—΄λ“¤μ„ μμ„λ€λ΅ κΊΌλ‚΄ `PnLTracer`μ—κ² μ „λ‹¬ν•©λ‹λ‹¤.
    5. `PnLTracer`λ” **μ¬κ³„μ‚° μ—†μ΄(no re-computation)** μ΄ λ°°μ—΄λ“¤λ΅ PnLμ„ κ³„μ‚°ν•μ—¬ μ‚¬μ©μμ—κ² λ¦¬ν¬νΈν•©λ‹λ‹¤.
